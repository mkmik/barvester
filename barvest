#!/bin/bash

#BASE=http://oai.driver.research-infrastructures.eu/
#BASE=http://node1.integration.driver.research-infrastructures.eu:8280/is/mvc/oai/oai.do
BASE=http://zaguan.unizar.es/oai2d
MDFORMAT=oai_dc
SET=
DELAY=8

###############################

listRecordsCommand() {
 TOKEN=$1
 if [ -z "$TOKEN" ]; then
	 echo "$BASE?verb=ListRecords&metadataPrefix=$MDFORMAT"
 else
	 echo "$BASE?verb=ListRecords&resumptionToken=$TOKEN"
 fi
}

parseResumptionToken() {
  grep resumptionToken | sed 's/.*>\(.*\)<.*/\1/'
}

download() {
  PARAMS=$1
  ERR=1
  #echo  >&2 "wget -q -O- $1"
  while true; do
	  wget -q -t 10 -O/tmp/barvest.tmp $PARAMS
	  ERR=$?

	  cat /tmp/barvest.tmp >>/tmp/barvest.dump
	  if [ "$ERR" == "0" ]; then
		  break
	  fi

	  echo >&2 "got error from wget, retrying"
	  sleep 5
  done
  cat  /tmp/barvest.tmp
}

COUNT=0
TOKEN=""
while true; do
	echo "fetching token: $TOKEN"
	TOKEN=$(download $(listRecordsCommand $TOKEN) | parseResumptionToken)
	if [ -z "$TOKEN" ]; then
		echo "no more pages"
		break
	fi
	COUNT=$((COUNT + 1))

	echo "sleeping $DELAY"
	sleep $DELAY
done
echo "done"
echo "Fetched $COUNT pages"
